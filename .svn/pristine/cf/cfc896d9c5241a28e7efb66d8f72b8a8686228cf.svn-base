<?php
namespace Home\Controller;
use Think\Controller;

class IndexController extends Controller {
    public function index() {
        $product = M('product');
        $dao = M();
        $promotionData = $dao->query("SELECT * from product as po INNER JOIN (SELECT p.product_id,child.`value` from package as p INNER JOIN (SELECT `value`,package_id from promotion as pr LEFT JOIN (SELECT min(promotion_id) a,package_id from package_promotion_date GROUP BY package_id ) as c on pr.id = c.a) as child on p.id = child.package_id) as pack on po.id = pack.product_id ORDER BY RAND() LIMIT 6;");
        $this->assign('promotionData',$promotionData);//促销
        $this->display();
    }

    //留言页面
    public function custom() {
        $this->display();
    }
    //处理留言
    public function customMessage() {
        $arr = I();
        $str = "";
        if ($arr['phone']) {
            if (!preg_match("/1[3458]{1}\d{9}$/", $arr['phone'])) {
                $this->resultMsg('error', '请输入正确的电话号码');
            }
            $str = '<br>手机号：' . $arr['phone'];
        }
        if ($arr['email']) {
            if (!preg_match("/[a-zA-Z0-9]+@[a-zA-Z0-9]+\.[a-z]{2,4}/", $arr['email'])) {
                $this->resultMsg('error', '请输入正确邮箱');
            }
            $str = '<br>邮箱：' . $arr['email'];
        }
        if ($arr['weixin']) {
            $str = '<br>微信：' . $arr['weixin'];
        }
        if (!$arr['name']) {
            $this->resultMsg('error', '请输入名字');
        }
        $customMessage = M('CustomMessage');
        $arr['createtime'] = date('Y-m-d H:i:s');
        $customMessage->data($arr)->add();
        sendMail('hi@wederful.com', 'wederful用户定制留言', '用户名：' . $arr['name'] . '<br>目的地：' . $arr['destination'] . '<br>期待婚礼类型：' . $arr['type'] . '<br>亲友人数：' . $arr['number'] . $str);
        $this->resultMsg('success', '提交成功');
    }

    public function fullpage(){
        $this->display();
    }

    /**
     * [updateRate 实时更新汇率]
     * @return [type] [description]
     */
    public function updateRate(){
        $rate = usdtosnyApi();
        $system = M('system_seting');
        $where = array('name'=>'rate');
        $system->where($where)->data(array('value'=>$rate))->save();
        $this->resultMsg('success', '更新汇率成功');
    }

    /**
     * [resultMsg 公共信息返回]
     * @param  [type] $status [返回状态,success或error]
     * @param  [type] $msg    [返回消息]
     * @param  string $data   [返回值]
     * @return [type]         [json]
     */
    Public function resultMsg($status, $msg, $data = '') {
        $array['status'] = $status;
        $array['message'] = $msg;
        $array['data'] = $data;
        $this->ajaxReturn($array, 'json');
    }
}
