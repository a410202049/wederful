/**
 * 2015-12-08 by hangyangws
 * [Goods 商品管理]
 */

! function($) {
    "use strict";
    var Goods = (function() {
        var $dateWrap = $allWrap.find('.package-form'),
            addDom = {
                unDayDom: $('#unDayDom').html(),
                dayPriceDom: $('#dayPriceDom').html(),
                goodsPromotDom: $('#goodsPromotDom').html(),
                exPriceDom: $('#exPriceDom').html()
            },
            $category = $allWrap.find('.category-type'), // 一级类型
            $provider = $allWrap.find('.provider-type'), // 服务商
            $service = $allWrap.find('.service-type'), // 服务项
            $area = $allWrap.find('.area-type'), // 服务地区
            $siteOnly = $allWrap.find('.site-only'),
            $siteOnlyInput = $allWrap.find('.site-only').find('input'),
            _operation = true;
        return {
            ini: function() {
                Pj.inputText();
                Pj.inputDate($dateWrap);
            },
            addDom: function($this) {
                $this.prev().append(addDom[$this.data('html')]);
                // 初始化日期
                Pj.inputDate($dateWrap, 'restart');
            },
            removeGldp: function($this) {
                var $input = $this.parent().find('input'),
                    _l = $input.length;
                while (_l--) {
                    $input.eq(_l).attr('gldp-id');
                    $('div[gldp-el="' + $input.eq(_l).attr('gldp-id') + '"]').remove();
                };
            },
            choiceOperation: function($this, _type) {
                var _id,
                    _d = ['<option value="null">选择服务' + (_type === 'category' ? '商' : '项') + '</option>'],
                    _l,
                    _only_l;
                if (_operation) {
                    _id = $this.val();
                    if (_id !== 'null') {
                        _operation = false;
                        $.ajax({
                            type: 'POST',
                            url: _type === 'category' ? global.getVendorsUrl : global.getServicesUrl,
                            dataType: 'json',
                            data: {
                                id: _id
                            },
                            success: function(r) {
                                if (r.status === 'success') {
                                    // 如果是婚礼场地 就把摄影没有的删掉
                                    if ($this.find('option[value="' + $this.val() + '"]').html() !== '婚礼场地') {
                                        $siteOnly.hide();
                                        $siteOnlyInput.removeAttr('name');
                                    } else {
                                        _only_l = $siteOnlyInput.length;
                                        while(_only_l--) {
                                            $siteOnlyInput.eq(_only_l).attr('name', $siteOnlyInput.eq(_only_l).data('name'));
                                        };
                                        $siteOnly.show();
                                    };

                                    _l = r.data.length;
                                    while (_l--) {
                                        _d.push('<option value="' + r.data[_l].id + '">' + r.data[_l].name + '</option>')
                                    };
                                    _d.join('');
                                    if (_type === 'category') {
                                        $provider.html(_d.length < 1 ? '<option value="null">此分类下面服务商</option>' : _d);
                                    } else {
                                        $service.html(_d.length < 1 ? '<option value="null">此服务商下面服务项</option>' : _d);
                                    };
                                } else {
                                    $.remaind(r.message, true);
                                };
                                _operation = true;
                            },
                            error: function() {
                                $.remaind('网络堵塞', true);
                                _operation = true;
                            }
                        });
                    } else {
                        _type === 'category' && $provider.html('<option value="null">选择服务商</option>');
                        $service.html('<option value="null">选择服务项</option>');
                    };
                };
            }
        };
    })();
    Goods.ini();
    $allWrap.on('click', '.add-dom', function() {
        Goods.addDom($(this));
    });
    // 删除临时节点
    $allWrap.on('click', '.del-temp-dom', function() {
        Goods.removeGldp($(this));
    });
    // 类型选择
    $allWrap.on('change', '.category-type', function() {
        Goods.choiceOperation($(this), 'category');
    });
    // 服务商选择
    $allWrap.on('change', '.provider-type', function() {
        Goods.choiceOperation($(this), 'provider');
    });
}(jQuery);
