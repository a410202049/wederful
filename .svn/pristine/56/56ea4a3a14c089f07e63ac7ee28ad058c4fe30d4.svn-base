<?php
// +----------------------------------------------------------------------
// | Copyright (c) 2013 http://www.onethink.cn All rights reserved.
// +----------------------------------------------------------------------
// | Author: kerry.gao <1509699669@vip.qq.com> <http://weibo.com/coderzero>
// +----------------------------------------------------------------------
namespace Admin\Controller;
use Think\Controller;
use Think\Upload\Driver\Qiniu\QiniuStorage;

class ServiceController extends BaseController {

  /**
   * [serviceManage 服务项管理]
   * @return [type] [description]
   */
  public function index(){
    $arr = I();
    $table = M('product');
    $vendors = M('vendors');
    $where = array();
    $pagesize = C('BACKEND_PAGESIZE');

    $vendorsArr = array();
    if($arr['categoryid']){
        $relat = M('vendorsCategoryRelation');
        $data =$relat->where(array('category_id'=>$arr['categoryid']))->select();
        foreach ($data as $k => $v) {
          $vdata = $vendors->where(array('id'=>$v['vendors_id']))->find();
          $vendorsArr[] = $vdata;
        }
        $where['category_id'] = $arr['categoryid'];
    }

    if($arr['vendorid']){
        $where['vendors_id'] = $arr['vendorid'];
    }

    $count = $table->where($where)->count();
    $page = getpage($count,$pagesize);
    $result = $table->where($where)->limit($page->firstRow.','.$page->listRows)->select();

    $category = D('ProductCategory');
    $categorys = $category->where(array('parent_id'=>0))->select();
    $totalPage = ceil($count/$pagesize);
    $totalSize = $count;
    $nowPage = $arr['p'] && $arr['p'] > 1 ? $arr['p'] : 1;
    foreach ($result as $key => $value) {
        $cid = $value['category_id'];
        $vid = $value['vendors_id'];
        $cate = $category->where(array('id'=>$cid))->find();
        $vendor =$vendors->where(array('id'=>$vid))->find();
        $result[$key]['categoryName'] = $cate['name'];
        $result[$key]['vendorName'] = $vendor['name'];
    }


    $this->assign('vendorsArr', $vendorsArr);
    $this->assign('result', $result); // 赋值数据集
    $this->assign('nowPage',$nowPage);
    $this->assign('categorys',$categorys);
    $this->assign('totalSize',$totalSize);
    $this->assign('totalPage',$totalPage);
    $this->display();
  }

  
    // public function index(){
    // 	$table = M('ProductCategory');
    //     $condition = array(
    //         'parent_id' => 0
    //     );
    //     $categorys = $table->where($condition)->select();
    //     $this->assign('categorys', $categorys);
    //     $this->display();
    // }

    public function getVendors(){
    	$arr = I();
        $dao = M();
        $data = array();
        if($arr['id']){
            $data = $dao->query("SELECT id,name from vendors where id in (SELECT vendors_id from vendors_category_relation where category_id = '%s')",$arr['id']);
        }
        $this->resultMsg('success', '获取成功',$data);

    }

    public function addServiceOne(){
        $arr = I();
        $category = D('ProductCategory');
        $categorys = $category->where(array('parent_id'=>0))->select();
        $this->assign('categorys',$categorys);
        $this->display();
    }

    public function addServiceOneMethod(){
        $arr = I();
        $table = D('Product');
        $relatinal = M('ProductAttrRelational');
        if ($arr['destination_id'] == 'null') {
            $arr['destination_id'] = $arr['regional_id'];
        }
        if (!$table->create($arr)) {
            $this->error($table->getError() , U('Service/addServiceOne'));
        }
        $id = $table->add();
        foreach ($arr['attr'] as $key => $value) {
            if (is_array($value)) {
                //判断如果是多选，就把字段用|分割存
                $str = "";
                
                foreach ($value as $k => $v) {
                    $str.= $v . '|';
                }
                $str = substr($str, 0, -1);
                $data = array(
                    'product_id' => $id,
                    'attr_id' => $key,
                    'value' => $str
                );
            } else {
                $data = array(
                    'product_id' => $id,
                    'attr_id' => $key,
                    'value' => $value
                );
            }
            $relatinal->data($data)->add();
        }
        $this->redirect('Service/addServiceTwo', array(
            'pid' => $id
        ));
    }

    public function addServiceTwo(){
        $this->display();
    }

}
